#!/bin/bash

###############################################################################
# Android SDK Installation Script
# Command-line tools for Android development
###############################################################################

TOOL_NAME="android-sdk"
TOOL_DIR="/opt/android-pentest/tools/${TOOL_NAME}"
BIN_DIR="/opt/android-pentest/bin"
LOG_FILE="/opt/android-pentest/logs/${TOOL_NAME}_install.log"

source /opt/android-pentest/scripts/common_functions.sh

install_android_sdk() {
    log_info "Installing ${TOOL_NAME}..."
    
    mkdir -p "${TOOL_DIR}"
    cd "${TOOL_DIR}"
    
    # Download Android command-line tools
    log_info "Downloading Android command-line tools..."
    wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip >> "$LOG_FILE" 2>&1
    
    unzip -q commandlinetools-linux-11076708_latest.zip
    rm commandlinetools-linux-11076708_latest.zip
    
    # Organize directory structure
    mkdir -p cmdline-tools/latest
    mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
    
    # Set ANDROID_HOME
    export ANDROID_HOME="${TOOL_DIR}"
    export PATH="${TOOL_DIR}/cmdline-tools/latest/bin:${TOOL_DIR}/platform-tools:$PATH"
    
    # Accept licenses and install platform tools
    log_info "Installing Android platform tools..."
    yes | "${TOOL_DIR}/cmdline-tools/latest/bin/sdkmanager" "platform-tools" >> "$LOG_FILE" 2>&1
    yes | "${TOOL_DIR}/cmdline-tools/latest/bin/sdkmanager" "build-tools;34.0.0" >> "$LOG_FILE" 2>&1
    
    # Create wrapper scripts
    create_wrapper "adb" "${TOOL_DIR}/platform-tools/adb" ""
    create_wrapper "fastboot" "${TOOL_DIR}/platform-tools/fastboot" ""
    create_wrapper "sdkmanager" "${TOOL_DIR}/cmdline-tools/latest/bin/sdkmanager" ""
    
    # Create environment setup script
    cat > "${TOOL_DIR}/setup_env.sh" << 'EOF'
#!/bin/bash
export ANDROID_HOME="/opt/android-pentest/tools/android-sdk"
export PATH="${ANDROID_HOME}/cmdline-tools/latest/bin:${ANDROID_HOME}/platform-tools:${ANDROID_HOME}/build-tools/34.0.0:$PATH"
EOF
    
    log_success "${TOOL_NAME} installed successfully"
    log_info "To use Android SDK tools, source: ${TOOL_DIR}/setup_env.sh"
}

install_android_sdk
