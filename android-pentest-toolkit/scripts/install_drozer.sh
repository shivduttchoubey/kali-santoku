#!/bin/bash

###############################################################################
# Drozer Installation Script (with virtual environment)
# Android security assessment framework
###############################################################################

TOOL_NAME="drozer"
TOOL_DIR="/opt/android-pentest/tools/${TOOL_NAME}"
VENV_DIR="${TOOL_DIR}/venv"
BIN_DIR="/opt/android-pentest/bin"
LOG_FILE="/opt/android-pentest/logs/${TOOL_NAME}_install.log"

source /opt/android-pentest/scripts/common_functions.sh

install_drozer() {
    log_info "Installing ${TOOL_NAME}..."
    
    mkdir -p "${TOOL_DIR}"
    cd "${TOOL_DIR}"
    
    # Clone Drozer repository (using maintained fork)
    log_info "Cloning Drozer repository..."
    git clone https://github.com/WithSecureLabs/drozer.git . >> "$LOG_FILE" 2>&1
    
    # Create virtual environment
    create_python_venv "${TOOL_NAME}" "${VENV_DIR}"
    
    # Install drozer
    log_info "Installing drozer in virtual environment..."
    "${VENV_DIR}/bin/pip" install . >> "$LOG_FILE" 2>&1
    
    # Create wrapper script
    create_wrapper "drozer" "${VENV_DIR}/bin/drozer" "${VENV_DIR}"
    
    # Download Drozer agent APK
    log_info "Downloading Drozer agent APK..."
    wget https://github.com/WithSecureLabs/drozer/releases/download/3.0.0/agent.apk -O "${TOOL_DIR}/drozer-agent.apk" >> "$LOG_FILE" 2>&1
    
    log_success "${TOOL_NAME} installed successfully"
    log_info "Drozer agent APK: ${TOOL_DIR}/drozer-agent.apk"
}

install_drozer
