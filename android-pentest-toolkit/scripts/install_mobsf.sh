#!/bin/bash

###############################################################################
# Mobile Security Framework (MobSF) Installation Script
# Automated mobile app security testing framework
###############################################################################

TOOL_NAME="mobsf"
TOOL_DIR="/opt/android-pentest/tools/${TOOL_NAME}"
VENV_DIR="${TOOL_DIR}/venv"
BIN_DIR="/opt/android-pentest/bin"
LOG_FILE="/opt/android-pentest/logs/${TOOL_NAME}_install.log"

source /opt/android-pentest/scripts/common_functions.sh

install_mobsf() {
    log_info "Installing ${TOOL_NAME}..."
    
    mkdir -p "${TOOL_DIR}"
    cd "${TOOL_DIR}"
    
    # Clone MobSF repository
    log_info "Cloning MobSF repository..."
    git clone https://github.com/MobSF/Mobile-Security-Framework-MobSF.git . >> "$LOG_FILE" 2>&1
    
    # Create virtual environment
    create_python_venv "${TOOL_NAME}" "${VENV_DIR}"
    
    # Install dependencies
    log_info "Installing MobSF dependencies..."
    "${VENV_DIR}/bin/pip" install -r requirements.txt >> "$LOG_FILE" 2>&1
    
    # Create launcher script
    cat > "${TOOL_DIR}/mobsf" << 'EOF'
#!/bin/bash
source /opt/android-pentest/tools/mobsf/venv/bin/activate
cd /opt/android-pentest/tools/mobsf
python manage.py runserver 0.0.0.0:8000
EOF
    
    chmod +x "${TOOL_DIR}/mobsf"
    
    # Create wrapper script
    create_wrapper "mobsf" "${TOOL_DIR}/mobsf" "${VENV_DIR}"
    
    log_success "${TOOL_NAME} installed successfully"
    log_info "To start MobSF, run: mobsf"
    log_info "Access MobSF at: http://localhost:8000"
}

install_mobsf
