#!/bin/bash

###############################################################################
# Common Functions Library
# Shared functions for all installation scripts
###############################################################################

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1" | tee -a "$LOG_FILE"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1" | tee -a "$LOG_FILE"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1" | tee -a "$LOG_FILE"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1" | tee -a "$LOG_FILE"
}

create_python_venv() {
    local tool_name=$1
    local venv_path=$2
    
    log_info "Creating Python virtual environment for ${tool_name}..."
    python3 -m venv "${venv_path}" >> "$LOG_FILE" 2>&1
    
    # Upgrade pip in venv
    "${venv_path}/bin/pip" install --upgrade pip >> "$LOG_FILE" 2>&1
}

create_wrapper() {
    local tool_name=$1
    local exec_path=$2
    local venv_path=$3  # Optional, for Python tools
    
    local wrapper_script="${BIN_DIR}/${tool_name}"
    
    cat > "${wrapper_script}" << EOF
#!/bin/bash
# Wrapper script for ${tool_name}

EOF
    
    if [[ -n "$venv_path" ]]; then
        cat >> "${wrapper_script}" << EOF
# Activate virtual environment
source "${venv_path}/bin/activate"

# Run the tool
exec "${exec_path}" "\$@"
EOF
    else
        cat >> "${wrapper_script}" << EOF
# Run the tool
exec "${exec_path}" "\$@"
EOF
    fi
    
    chmod +x "${wrapper_script}"
    log_info "Created wrapper script: ${wrapper_script}"
}

install_java_tool() {
    local tool_name=$1
    local download_url=$2
    local jar_name=$3
    
    log_info "Installing Java tool: ${tool_name}..."
    
    local tool_dir="/opt/android-pentest/tools/${tool_name}"
    mkdir -p "${tool_dir}"
    
    wget -O "${tool_dir}/${jar_name}" "${download_url}" >> "$LOG_FILE" 2>&1
    
    # Create launcher script
    cat > "${tool_dir}/${tool_name}" << EOF
#!/bin/bash
java -jar "${tool_dir}/${jar_name}" "\$@"
EOF
    
    chmod +x "${tool_dir}/${tool_name}"
    create_wrapper "${tool_name}" "${tool_dir}/${tool_name}" ""
}

check_command() {
    local cmd=$1
    if command -v "$cmd" &> /dev/null; then
        return 0
    else
        return 1
    fi
}
