#!/bin/bash

###############################################################################
# Frida Installation Script (with virtual environment)
# Dynamic instrumentation toolkit
###############################################################################

TOOL_NAME="frida"
TOOL_DIR="/opt/android-pentest/tools/${TOOL_NAME}"
VENV_DIR="${TOOL_DIR}/venv"
BIN_DIR="/opt/android-pentest/bin"
LOG_FILE="/opt/android-pentest/logs/${TOOL_NAME}_install.log"

source /opt/android-pentest/scripts/common_functions.sh

install_frida() {
    log_info "Installing ${TOOL_NAME}..."
    
    mkdir -p "${TOOL_DIR}"
    
    # Create virtual environment
    create_python_venv "${TOOL_NAME}" "${VENV_DIR}"
    
    # Install frida and frida-tools
    log_info "Installing frida and frida-tools in virtual environment..."
    "${VENV_DIR}/bin/pip" install frida frida-tools >> "$LOG_FILE" 2>&1
    
    # Create wrapper scripts
    create_wrapper "frida" "${VENV_DIR}/bin/frida" "${VENV_DIR}"
    create_wrapper "frida-ps" "${VENV_DIR}/bin/frida-ps" "${VENV_DIR}"
    create_wrapper "frida-trace" "${VENV_DIR}/bin/frida-trace" "${VENV_DIR}"
    create_wrapper "frida-discover" "${VENV_DIR}/bin/frida-discover" "${VENV_DIR}"
    create_wrapper "frida-ls-devices" "${VENV_DIR}/bin/frida-ls-devices" "${VENV_DIR}"
    create_wrapper "frida-kill" "${VENV_DIR}/bin/frida-kill" "${VENV_DIR}"
    
    # Test installation
    if "${VENV_DIR}/bin/frida" --version >> "$LOG_FILE" 2>&1; then
        log_success "${TOOL_NAME} installed successfully"
        "${VENV_DIR}/bin/frida" --version | tee -a "$LOG_FILE"
    else
        log_error "${TOOL_NAME} installation failed"
        return 1
    fi
}

install_frida
