#!/bin/bash

###############################################################################
# Android Penetration Testing Toolkit - Master Installer
# Based on Santoku Linux Tools with Modern Additions
# 
# This script automates the installation of all Android pentesting tools
# with isolated virtual environments for each tool
#
# Usage: sudo bash master_install.sh
###############################################################################

set -e  # Exit on error

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Installation directories
INSTALL_BASE="/opt/android-pentest"
TOOLS_DIR="${INSTALL_BASE}/tools"
BIN_DIR="${INSTALL_BASE}/bin"
LOGS_DIR="${INSTALL_BASE}/logs"

# Log file
LOG_FILE="${LOGS_DIR}/installation_$(date +%Y%m%d_%H%M%S).log"

###############################################################################
# Helper Functions
###############################################################################

log() {
    echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1" | tee -a "$LOG_FILE"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1" | tee -a "$LOG_FILE"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1" | tee -a "$LOG_FILE"
}

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1" | tee -a "$LOG_FILE"
}

check_root() {
    if [[ $EUID -ne 0 ]]; then
        log_error "This script must be run as root (use sudo)"
        exit 1
    fi
}

create_directories() {
    log "Creating directory structure..."
    mkdir -p "${TOOLS_DIR}"
    mkdir -p "${BIN_DIR}"
    mkdir -p "${LOGS_DIR}"
    chmod 755 "${INSTALL_BASE}"
}

###############################################################################
# System Preparation
###############################################################################

update_system() {
    log "Updating system packages..."
    apt update >> "$LOG_FILE" 2>&1
    log "System update complete"
}

install_base_dependencies() {
    log "Installing base dependencies..."
    
    local packages=(
        # Build essentials
        build-essential
        git
        wget
        curl
        unzip
        zip
        
        # Python
        python3
        python3-pip
        python3-venv
        python3-dev
        
        # Java
        default-jdk
        default-jre
        
        # Libraries
        libssl-dev
        libffi-dev
        libxml2-dev
        libxslt1-dev
        zlib1g-dev
        
        # Other essentials
        adb
        fastboot
        android-sdk-platform-tools
        
        # Network tools
        wireshark
        tcpdump
        nmap
        
        # Utilities
        hexedit
        binwalk
        sqlite3
    )
    
    for package in "${packages[@]}"; do
        log_info "Installing $package..."
        apt install -y "$package" >> "$LOG_FILE" 2>&1 || log_warning "Failed to install $package"
    done
    
    log "Base dependencies installed"
}

###############################################################################
# Main Installation Function
###############################################################################

main() {
    log "=========================================="
    log "Android Penetration Testing Toolkit"
    log "Master Installation Script"
    log "=========================================="
    
    check_root
    create_directories
    update_system
    install_base_dependencies
    
    log "Installing individual tools..."
    
    # Core Android Tools
    bash "${TOOLS_DIR}/../scripts/install_apktool.sh" || log_error "Failed to install Apktool"
    bash "${TOOLS_DIR}/../scripts/install_jadx.sh" || log_error "Failed to install JADX"
    bash "${TOOLS_DIR}/../scripts/install_dex2jar.sh" || log_error "Failed to install dex2jar"
    bash "${TOOLS_DIR}/../scripts/install_jd-gui.sh" || log_error "Failed to install JD-GUI"
    
    # Python-based tools (with virtual environments)
    bash "${TOOLS_DIR}/../scripts/install_androguard.sh" || log_error "Failed to install Androguard"
    bash "${TOOLS_DIR}/../scripts/install_frida.sh" || log_error "Failed to install Frida"
    bash "${TOOLS_DIR}/../scripts/install_objection.sh" || log_error "Failed to install Objection"
    bash "${TOOLS_DIR}/../scripts/install_mitmproxy.sh" || log_error "Failed to install mitmproxy"
    bash "${TOOLS_DIR}/../scripts/install_mobsf.sh" || log_error "Failed to install MobSF"
    bash "${TOOLS_DIR}/../scripts/install_drozer.sh" || log_error "Failed to install Drozer"
    
    # Additional tools
    bash "${TOOLS_DIR}/../scripts/install_android_sdk.sh" || log_error "Failed to install Android SDK"
    bash "${TOOLS_DIR}/../scripts/install_burpsuite.sh" || log_error "Failed to install Burp Suite"
    bash "${TOOLS_DIR}/../scripts/install_radare2.sh" || log_error "Failed to install Radare2"
    
    log "Creating wrapper scripts..."
    create_wrapper_scripts
    
    log "=========================================="
    log "Installation Complete!"
    log "=========================================="
    log_info "Tools installed in: ${TOOLS_DIR}"
    log_info "Wrapper scripts in: ${BIN_DIR}"
    log_info "Add ${BIN_DIR} to your PATH:"
    echo ""
    echo "    export PATH=\"${BIN_DIR}:\$PATH\""
    echo ""
    log_info "Installation log: ${LOG_FILE}"
}

create_wrapper_scripts() {
    # This will be populated by individual install scripts
    log "Wrapper scripts created by individual installers"
}

# Run main installation
main "$@"
